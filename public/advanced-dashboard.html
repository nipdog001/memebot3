<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Meme Millionaire Bot - ML Model Tracking & Exchange Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: #4ade80;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }

        .container {
            max-width: 1800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .balance-card {
            background: linear-gradient(135deg, #1a1f3a 0%, #242b47 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(74, 222, 128, 0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        .balance-value {
            font-size: 48px;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 10px;
        }

        .balance-value.negative {
            color: #f87171;
        }

        .balance-label {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 222, 128, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1f3a 0%, #242b47 100%);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #4ade80;
        }

        .stat-value.red {
            color: #f87171;
        }

        .stat-value.positive {
            color: #4ade80;
        }

        .stat-value.negative {
            color: #f87171;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: linear-gradient(135deg, #1a1f3a 0%, #242b47 100%);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-item {
            display: grid;
            grid-template-columns: 0.7fr 0.8fr 1fr 0.6fr 0.6fr 0.8fr 0.8fr;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
            align-items: center;
        }

        .trade-item:first-child {
            font-weight: 600;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .positive { color: #4ade80; }
        .negative { color: #f87171; }

        .trade-flash {
            animation: flashIn 0.8s ease-out;
        }

        @keyframes flashIn {
            0% { background: rgba(74, 222, 128, 0.3); }
            100% { background: transparent; }
        }

        .ml-model {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .model-info {
            flex: 1;
        }

        .model-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .model-stats {
            font-size: 12px;
            color: #94a3b8;
        }

        .model-accuracy {
            font-weight: 600;
            margin-right: 10px;
        }

        .accuracy-high { color: #4ade80; }
        .accuracy-medium { color: #fbbf24; }
        .accuracy-low { color: #f87171; }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #374151;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #4ade80;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .exchange-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .exchange-info {
            flex: 1;
        }

        .exchange-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .exchange-stats {
            font-size: 12px;
            color: #94a3b8;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #4ade80;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .pairs-grid {
            max-height: 400px;
            overflow-y: auto;
        }

        .pair-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 4px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 14px;
        }

        .pair-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meme-badge {
            background: #f59e0b;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .fee-breakdown {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .notification.success {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }

        .notification.error {
            background: linear-gradient(135deg, #f87171, #ef4444);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .trading-mode-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
        }

        .trading-mode-indicator.paper {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .trading-mode-indicator.live {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .ml-decisions-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .ml-decisions-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #242b47 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            width: 800px;
        }

        .ml-decisions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ml-decisions-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .ml-decision-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid #4ade80;
        }

        .ml-decision-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ml-decision-details {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.4;
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(74, 222, 128, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 222, 128, 0.5);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>🤖 Meme Millionaire Bot</h1>
            </div>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="status">Initializing...</span>
                </div>
                <div class="trading-mode-indicator paper" id="tradingModeIndicator">
                    📄 Paper Trading
                </div>
                <div class="status-indicator">
                    <span id="mlStatus">8 ML Models</span>
                </div>
                <div class="status-indicator">
                    <span id="exchangeStatus">0 Exchanges</span>
                </div>
                <div class="status-indicator">
                    <span id="pairStatus">0 Pairs</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="balance-card">
            <div class="balance-value" id="balance">$10,000.00</div>
            <div class="balance-label">Capital Balance (Starting: $10,000 + Total Profit/Loss)</div>
            <button class="btn btn-primary" onclick="toggleTrading()" id="tradingBtn">Start ML Trading</button>
            <button class="btn btn-warning" onclick="switchTradingMode()" id="tradingModeBtn">Switch to Live Trading</button>
            <button class="btn btn-danger" onclick="emergencyStop()">Emergency Stop</button>
            <button class="btn btn-secondary" onclick="resetStats()">Reset Stats</button>
            <a href="/reports" class="btn btn-secondary">📊 Tax Reports</a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Trades (Persistent)</div>
                <div class="stat-value" id="totalTrades">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Win Rate (Persistent)</div>
                <div class="stat-value" id="winRate">0.0%</div>
                <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                    <span id="winLossBreakdown">0 wins / 0 losses</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Fees Paid</div>
                <div class="stat-value red" id="totalFees">$0.00</div>
                <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                    <span id="avgFeePerTrade">$0.00 avg per trade</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Today's P&L</div>
                <div class="stat-value positive" id="dailyPL">+$0.00</div>
                <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                    Net profit after total fees paid
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ML Confidence</div>
                <div class="stat-value" id="mlConfidence">0.0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Enabled Pairs</div>
                <div class="stat-value" id="enabledPairs">0</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="section">
                <div class="section-title">
                    <span>⚡ Live ML Trading Activity (with Fees)</span>
                    <button class="btn btn-secondary" onclick="showMLDecisions()">View ML Decisions</button>
                </div>
                <div class="trade-item">
                    <span>Time</span>
                    <span>Pair</span>
                    <span>Route</span>
                    <span>ML Conf.</span>
                    <span>Fees</span>
                    <span>Profit</span>
                    <span>Models</span>
                </div>
                <div id="tradesList">
                    <div class="trade-item" style="text-align: center; grid-column: 1 / -1; padding: 40px; color: #94a3b8;">
                        Waiting for ML trading to start...
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <span>🧠 ML Models</span>
                    <button class="btn btn-secondary" onclick="refreshMLModels()">Refresh</button>
                </div>
                <div id="mlModelsList">
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        Loading ML models...
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <span>🏦 Exchanges</span>
                    <button class="btn btn-secondary" onclick="refreshExchanges()">Refresh</button>
                </div>
                <div id="exchangesList">
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        Loading exchanges...
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <span>🎯 Trading Pairs Management</span>
                <div>
                    <button class="btn btn-secondary" onclick="enableAllMemeCoins()">Enable All Meme Coins</button>
                    <button class="btn btn-secondary" onclick="disableAllPairs()">Disable All</button>
                    <button class="btn btn-secondary" onclick="refreshPairs()">Refresh</button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('all')">All Pairs</button>
                <button class="tab" onclick="showTab('meme')">Meme Coins</button>
                <button class="tab" onclick="showTab('enabled')">Enabled</button>
            </div>

            <div id="allPairs" class="tab-content active">
                <div class="pairs-grid" id="allPairsList">
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        Loading trading pairs...
                    </div>
                </div>
            </div>

            <div id="memePairs" class="tab-content">
                <div class="pairs-grid" id="memePairsList">
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        Loading meme coins...
                    </div>
                </div>
            </div>

            <div id="enabledPairsTab" class="tab-content">
                <div class="pairs-grid" id="enabledPairsList">
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        No pairs enabled
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Decisions Modal -->
    <div class="ml-decisions-modal" id="mlDecisionsModal">
        <div class="ml-decisions-content">
            <div class="ml-decisions-header">
                <h2>🧠 ML Trading Decisions</h2>
                <button class="btn btn-secondary" onclick="closeMLDecisions()">Close</button>
            </div>
            <div class="ml-decisions-list" id="mlDecisionsList">
                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                    No ML decisions recorded yet. Start trading to see ML decision history.
                </div>
            </div>
        </div>
    </div>

    <script>
        let isTrading = false;
        let isLiveTrading = false;
        let balance = 10000;
        let startingBalance = 10000;
        let trades = [];
        let mlDecisions = [];
        let ws = null;
        let persistentStats = {
            totalTrades: 0,
            winningTrades: 0,
            losingTrades: 0,
            totalProfit: 0,
            totalFees: 0,
            dailyPL: 0,
            winRate: 0
        };
        let allPairsData = {};
        let mlModelsData = {};

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => {
                console.log('📡 Connected to Meme Millionaire Bot');
                document.getElementById('status').textContent = 'Connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'initial_data':
                    balance = data.data.balance;
                    updateBalance();
                    if (data.data.persistentStats) {
                        persistentStats = data.data.persistentStats;
                        updatePersistentStats();
                    }
                    if (data.data.isLiveTrading !== undefined) {
                        isLiveTrading = data.data.isLiveTrading;
                        updateTradingModeIndicator();
                    }
                    document.getElementById('mlStatus').textContent = `${data.data.mlModels} ML Models`;
                    document.getElementById('exchangeStatus').textContent = `${data.data.exchanges} Exchanges`;
                    document.getElementById('pairStatus').textContent = `${data.data.enabledPairs} Pairs`;
                    if (data.data.mlConfidence !== undefined) {
                        document.getElementById('mlConfidence').textContent = `${data.data.mlConfidence.toFixed(1)}%`;
                    }
                    break;
                case 'new_trade':
                    addTradeToList(data.data);
                    addMLDecision(data.data);
                    break;
                case 'balance_update':
                    balance = data.data.balance;
                    updateBalance();
                    break;
                case 'stats_update':
                    persistentStats = data.data;
                    updatePersistentStats();
                    if (data.data.mlConfidence !== undefined) {
                        document.getElementById('mlConfidence').textContent = `${data.data.mlConfidence.toFixed(1)}%`;
                    }
                    break;
                case 'stats_reset':
                    persistentStats = data.data;
                    updatePersistentStats();
                    balance = startingBalance;
                    updateBalance();
                    mlDecisions = [];
                    document.getElementById('tradesList').innerHTML = '<div class="trade-item" style="text-align: center; grid-column: 1 / -1; padding: 40px; color: #94a3b8;">Waiting for ML trading to start...</div>';
                    showNotification('Statistics reset successfully!', 'success');
                    break;
                case 'trading_started':
                    isTrading = true;
                    updateTradingButton();
                    break;
                case 'trading_stopped':
                    isTrading = false;
                    updateTradingButton();
                    break;
                case 'trading_mode_changed':
                    isLiveTrading = data.data.isLiveTrading;
                    updateTradingModeIndicator();
                    showNotification(`Switched to ${data.data.mode} trading mode`, 'success');
                    break;
                case 'exchange_toggled':
                    refreshExchanges();
                    break;
                case 'pair_toggled':
                    refreshPairs();
                    break;
                case 'model_toggled':
                    refreshMLModels();
                    break;
            }
        }

        async function toggleTrading() {
            try {
                const endpoint = isTrading ? '/api/trading/stop' : '/api/trading/start';
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to toggle trading', 'error');
            }
        }

        async function switchTradingMode() {
            const newMode = isLiveTrading ? 'paper' : 'live';
            
            if (newMode === 'live') {
                if (!confirm('⚠️ WARNING: You are about to switch to LIVE TRADING mode!\n\nThis will use REAL MONEY for trades. Are you absolutely sure?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/trading/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: newMode })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isLiveTrading = result.mode === 'live';
                    updateTradingModeIndicator();
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message || 'Failed to switch trading mode', 'error');
                }
            } catch (error) {
                showNotification('Failed to switch trading mode', 'error');
            }
        }

        function updateTradingModeIndicator() {
            const indicator = document.getElementById('tradingModeIndicator');
            const modeBtn = document.getElementById('tradingModeBtn');
            
            if (isLiveTrading) {
                indicator.className = 'trading-mode-indicator live';
                indicator.textContent = '🔴 Live Trading';
                modeBtn.textContent = 'Switch to Paper Trading';
                modeBtn.className = 'btn btn-secondary';
            } else {
                indicator.className = 'trading-mode-indicator paper';
                indicator.textContent = '📄 Paper Trading';
                modeBtn.textContent = 'Switch to Live Trading';
                modeBtn.className = 'btn btn-warning';
            }
        }

        function updateTradingButton() {
            const btn = document.getElementById('tradingBtn');
            const status = document.getElementById('status');
            
            if (isTrading) {
                btn.textContent = 'Stop ML Trading';
                btn.className = 'btn btn-danger';
                status.textContent = 'ML Trading Active';
            } else {
                btn.textContent = 'Start ML Trading';
                btn.className = 'btn btn-primary';
                status.textContent = 'ML Trading Stopped';
            }
        }

        function emergencyStop() {
            if (confirm('Execute emergency stop?')) {
                fetch('/api/trading/stop', { method: 'POST' })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            isTrading = false;
                            updateTradingButton();
                            showNotification('Emergency stop executed!', 'error');
                        }
                    });
            }
        }

        async function resetStats() {
            if (confirm('Are you sure you want to reset all statistics? This will clear all trading history and reset the balance.')) {
                try {
                    const response = await fetch('/api/stats/reset', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification(result.message, 'success');
                    }
                } catch (error) {
                    showNotification('Failed to reset statistics', 'error');
                }
            }
        }

        function addTradeToList(trade) {
            const tradesList = document.getElementById('tradesList');
            
            if (tradesList.children.length === 1 && tradesList.children[0].textContent.includes('Waiting')) {
                tradesList.innerHTML = '';
            }
            
            const tradeDiv = document.createElement('div');
            tradeDiv.className = 'trade-item trade-flash';
            
            const time = new Date(trade.timestamp).toLocaleTimeString();
            const profit = trade.netProfit >= 0 ? `+$${trade.netProfit.toFixed(2)}` : `-$${Math.abs(trade.netProfit).toFixed(2)}`;
            const profitClass = trade.netProfit >= 0 ? 'positive' : 'negative';
            const mlConf = `${(trade.mlConfidence * 100).toFixed(1)}%`;
            const fees = `$${trade.totalFees.toFixed(2)}`;
            const models = trade.decidingModels ? trade.decidingModels.slice(0, 2).join(', ') + (trade.decidingModels.length > 2 ? '...' : '') : 'N/A';
            const modeIndicator = trade.isLive ? '🔴' : '📄';
            
            tradeDiv.innerHTML = `
                <span>${modeIndicator} ${time}</span>
                <span>${trade.symbol}</span>
                <span style="font-size: 11px;">${trade.buyExchange} → ${trade.sellExchange}</span>
                <span style="color: #4ade80;">${mlConf}</span>
                <span style="color: #f87171;">${fees}</span>
                <span class="${profitClass}">${profit}</span>
                <span style="font-size: 11px; color: #94a3b8;">${models}</span>
            `;
            
            // Add fee breakdown tooltip
            const feeBreakdown = document.createElement('div');
            feeBreakdown.className = 'fee-breakdown';
            feeBreakdown.innerHTML = `Buy: $${trade.buyFee.toFixed(2)} (${(trade.buyFeeRate * 100).toFixed(2)}%) | Sell: $${trade.sellFee.toFixed(2)} (${(trade.sellFeeRate * 100).toFixed(2)}%)`;
            tradeDiv.appendChild(feeBreakdown);
            
            tradesList.insertBefore(tradeDiv, tradesList.firstChild);
            
            while (tradesList.children.length > 20) {
                tradesList.removeChild(tradesList.lastChild);
            }
        }

        function addMLDecision(trade) {
            const decision = {
                id: trade.id,
                timestamp: trade.timestamp,
                symbol: trade.symbol,
                mlConfidence: trade.mlConfidence,
                decidingModels: trade.decidingModels || [],
                prediction: trade.netProfit > 0 ? 'Profitable' : 'Loss',
                actualOutcome: trade.netProfit > 0 ? 'Correct' : 'Incorrect',
                profit: trade.netProfit,
                fees: trade.totalFees,
                isLive: trade.isLive
            };
            
            mlDecisions.unshift(decision);
            
            // Keep only last 50 decisions
            if (mlDecisions.length > 50) {
                mlDecisions = mlDecisions.slice(0, 50);
            }
        }

        function showMLDecisions() {
            const modal = document.getElementById('mlDecisionsModal');
            const list = document.getElementById('mlDecisionsList');
            
            if (mlDecisions.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No ML decisions recorded yet. Start trading to see ML decision history.</div>';
            } else {
                list.innerHTML = '';
                
                mlDecisions.forEach(decision => {
                    const decisionDiv = document.createElement('div');
                    decisionDiv.className = 'ml-decision-item';
                    
                    const time = new Date(decision.timestamp).toLocaleString();
                    const confidence = (decision.mlConfidence * 100).toFixed(1);
                    const profitClass = decision.profit >= 0 ? 'positive' : 'negative';
                    const modeIndicator = decision.isLive ? '🔴 Live' : '📄 Paper';
                    
                    decisionDiv.innerHTML = `
                        <div class="ml-decision-header">
                            <div>
                                <strong>${decision.symbol}</strong> - ${modeIndicator}
                                <span class="model-accuracy accuracy-${decision.mlConfidence > 0.8 ? 'high' : decision.mlConfidence > 0.6 ? 'medium' : 'low'}">${confidence}% Confidence</span>
                            </div>
                            <div class="${profitClass}">
                                ${decision.profit >= 0 ? '+' : ''}$${decision.profit.toFixed(2)}
                            </div>
                        </div>
                        <div class="ml-decision-details">
                            <strong>Time:</strong> ${time}<br>
                            <strong>Models Used:</strong> ${decision.decidingModels.join(', ') || 'None'}<br>
                            <strong>Prediction:</strong> ${decision.prediction}<br>
                            <strong>Outcome:</strong> ${decision.actualOutcome}<br>
                            <strong>Fees:</strong> $${decision.fees.toFixed(2)}
                        </div>
                    `;
                    
                    list.appendChild(decisionDiv);
                });
            }
            
            modal.style.display = 'flex';
        }

        function closeMLDecisions() {
            document.getElementById('mlDecisionsModal').style.display = 'none';
        }

        function updatePersistentStats() {
            document.getElementById('totalTrades').textContent = persistentStats.totalTrades;
            document.getElementById('winRate').textContent = `${persistentStats.winRate.toFixed(1)}%`;
            document.getElementById('winLossBreakdown').textContent = `${persistentStats.winningTrades} wins / ${persistentStats.losingTrades} losses`;
            document.getElementById('totalFees').textContent = `$${persistentStats.totalFees.toFixed(2)}`;
            
            const avgFeePerTrade = persistentStats.totalTrades > 0 ? persistentStats.totalFees / persistentStats.totalTrades : 0;
            document.getElementById('avgFeePerTrade').textContent = `$${avgFeePerTrade.toFixed(2)} avg per trade`;
            
            const dailyPLElement = document.getElementById('dailyPL');
            dailyPLElement.textContent = persistentStats.dailyPL >= 0 ? 
                `+$${persistentStats.dailyPL.toFixed(2)}` : `-$${Math.abs(persistentStats.dailyPL).toFixed(2)}`;
            dailyPLElement.className = persistentStats.dailyPL >= 0 ? 'stat-value positive' : 'stat-value negative';
        }

        function updateBalance() {
            const balanceElement = document.getElementById('balance');
            
            // FIXED: Capital Balance = Starting Balance + Total Profit/Loss
            const capitalBalance = startingBalance + persistentStats.totalProfit;
            balanceElement.textContent = `$${capitalBalance.toFixed(2)}`;
            
            // Color coding based on profit/loss from starting balance
            if (capitalBalance > startingBalance) {
                balanceElement.className = 'balance-value'; // Green (default)
            } else if (capitalBalance < startingBalance) {
                balanceElement.className = 'balance-value negative'; // Red
            } else {
                balanceElement.className = 'balance-value'; // Neutral
            }
        }

        async function loadMLModels() {
            try {
                const response = await fetch('/api/ml/status');
                const data = await response.json();
                mlModelsData = data;
                
                const container = document.getElementById('mlModelsList');
                container.innerHTML = '';
                
                data.models.forEach(model => {
                    const modelDiv = document.createElement('div');
                    modelDiv.className = 'ml-model';
                    
                    const accuracyClass = model.accuracy > 80 ? 'accuracy-high' : 
                                        model.accuracy > 65 ? 'accuracy-medium' : 'accuracy-low';
                    
                    modelDiv.innerHTML = `
                        <div class="model-info">
                            <div class="model-name">${model.name}</div>
                            <div class="model-stats">
                                <span class="model-accuracy ${accuracyClass}">${model.accuracy.toFixed(1)}%</span>
                                ${model.predictions} predictions | 
                                $${model.profitGenerated.toFixed(2)} profit
                            </div>
                        </div>
                        <div class="toggle-switch ${model.enabled ? 'active' : ''}" 
                             onclick="toggleMLModel('${model.type}', ${!model.enabled})">
                        </div>
                    `;
                    
                    container.appendChild(modelDiv);
                });
                
                const activeModels = data.models.filter(m => m.enabled).length;
                document.getElementById('mlStatus').textContent = `${activeModels}/${data.models.length} ML Models`;
            } catch (error) {
                console.error('Error loading ML models:', error);
            }
        }

        async function toggleMLModel(modelType, enabled) {
            try {
                const response = await fetch(`/api/ml/model/${modelType}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification(`${modelType} ${enabled ? 'enabled' : 'disabled'}`, 'success');
                    refreshMLModels();
                }
            } catch (error) {
                showNotification('Failed to toggle model', 'error');
            }
        }

        async function loadExchanges() {
            try {
                const response = await fetch('/api/exchanges');
                const exchanges = await response.json();
                
                const container = document.getElementById('exchangesList');
                container.innerHTML = '';
                
                exchanges.forEach(exchange => {
                    const exchangeDiv = document.createElement('div');
                    exchangeDiv.className = 'exchange-item';
                    
                    const statusColor = exchange.connected ? '#4ade80' : 
                                      exchange.hasKeys ? '#fbbf24' : '#94a3b8';
                    
                    const statusText = exchange.connected ? '🟢 Connected' : 
                                     exchange.hasKeys ? '🟡 Configured' : '⚪ Public';
                    
                    exchangeDiv.innerHTML = `
                        <div class="exchange-info">
                            <div class="exchange-name">${exchange.name}</div>
                            <div class="exchange-stats">
                                Maker: ${(exchange.fees.maker * 100).toFixed(2)}% | Taker: ${(exchange.fees.taker * 100).toFixed(2)}% | 
                                ${exchange.totalPairs || 0} pairs | 
                                ${exchange.enabledPairs || 0} enabled
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: ${statusColor}; font-size: 13px;">${statusText}</span>
                            <div class="toggle-switch ${exchange.enabled ? 'active' : ''}" 
                                 onclick="toggleExchange('${exchange.id}', ${!exchange.enabled})">
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(exchangeDiv);
                });
                
                document.getElementById('exchangeStatus').textContent = `${exchanges.filter(e => e.connected).length} Exchanges`;
            } catch (error) {
                console.error('Error loading exchanges:', error);
            }
        }

        async function toggleExchange(exchangeId, enabled) {
            try {
                const response = await fetch(`/api/exchanges/${exchangeId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification(`${exchangeId} ${enabled ? 'enabled' : 'disabled'}`, 'success');
                    refreshExchanges();
                }
            } catch (error) {
                showNotification('Failed to toggle exchange', 'error');
            }
        }

        async function loadTradingPairs() {
            try {
                const response = await fetch('/api/pairs/all');
                const data = await response.json();
                allPairsData = data;
                
                updatePairsDisplay();
                
                document.getElementById('enabledPairs').textContent = data.enabledPairs;
                document.getElementById('pairStatus').textContent = `${data.enabledPairs} Pairs`;
            } catch (error) {
                console.error('Error loading trading pairs:', error);
            }
        }

        function updatePairsDisplay() {
            updateAllPairs();
            updateMemePairs();
            updateEnabledPairs();
        }

        function updateAllPairs() {
            const container = document.getElementById('allPairsList');
            container.innerHTML = '';
            
            for (const [exchange, pairs] of Object.entries(allPairsData.exchanges)) {
                pairs.forEach(pair => {
                    const pairDiv = createPairElement(exchange, pair);
                    container.appendChild(pairDiv);
                });
            }
        }

        function updateMemePairs() {
            const container = document.getElementById('memePairsList');
            container.innerHTML = '';
            
            for (const [exchange, pairs] of Object.entries(allPairsData.exchanges)) {
                pairs.filter(pair => pair.isMeme).forEach(pair => {
                    const pairDiv = createPairElement(exchange, pair);
                    container.appendChild(pairDiv);
                });
            }
        }

        function updateEnabledPairs() {
            const container = document.getElementById('enabledPairsList');
            container.innerHTML = '';
            
            let hasEnabledPairs = false;
            for (const [exchange, pairs] of Object.entries(allPairsData.exchanges)) {
                pairs.filter(pair => pair.enabled).forEach(pair => {
                    const pairDiv = createPairElement(exchange, pair);
                    container.appendChild(pairDiv);
                    hasEnabledPairs = true;
                });
            }
            
            if (!hasEnabledPairs) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No pairs enabled</div>';
            }
        }

        function createPairElement(exchange, pair) {
            const pairDiv = document.createElement('div');
            pairDiv.className = 'pair-item';
            
            pairDiv.innerHTML = `
                <div class="pair-info">
                    <span>${pair.symbol}</span>
                    ${pair.isMeme ? '<span class="meme-badge">MEME</span>' : ''}
                    <span style="font-size: 12px; color: #94a3b8;">${exchange}</span>
                </div>
                <div class="toggle-switch ${pair.enabled ? 'active' : ''}" 
                     onclick="togglePair('${exchange}', '${pair.symbol}', ${!pair.enabled})">
                </div>
            `;
            
            return pairDiv;
        }

        async function togglePair(exchange, symbol, enabled) {
            try {
                const response = await fetch('/api/pairs/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange, symbol, enabled })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification(`${symbol} ${enabled ? 'enabled' : 'disabled'}`, 'success');
                    refreshPairs();
                }
            } catch (error) {
                showNotification('Failed to toggle pair', 'error');
            }
        }

        async function enableAllMemeCoins() {
            if (confirm('Enable all meme coins for trading?')) {
                try {
                    const response = await fetch('/api/pairs/enable-meme-coins', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification(result.message, 'success');
                        refreshPairs();
                    }
                } catch (error) {
                    showNotification('Failed to enable meme coins', 'error');
                }
            }
        }

        async function disableAllPairs() {
            if (confirm('Disable all trading pairs?')) {
                try {
                    const response = await fetch('/api/pairs/disable-all', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification(result.message, 'success');
                        refreshPairs();
                    }
                } catch (error) {
                    showNotification('Failed to disable pairs', 'error');
                }
            }
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + (tabName === 'enabled' ? 'PairsTab' : 'Pairs')).classList.add('active');
        }

        function refreshMLModels() {
            loadMLModels();
        }

        function refreshExchanges() {
            loadExchanges();
        }

        function refreshPairs() {
            loadTradingPairs();
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Auto-start sequence
        function autoStartTrading() {
            console.log('🎯 Starting auto-initialization sequence...');
            
            // Step 1: Enable all meme coins after 3 seconds
            setTimeout(() => {
                console.log('📊 Auto-enabling all meme coins...');
                enableAllMemeCoins();
            }, 3000);
            
            // Step 2: Start paper trading after 5 seconds
            setTimeout(() => {
                if (!isTrading) {
                    console.log('🎯 Auto-starting paper trading...');
                    toggleTrading();
                }
            }, 5000);
        }

        // Initialize
        connectWebSocket();
        loadMLModels();
        loadExchanges();
        loadTradingPairs();
        
        // Start auto-initialization
        autoStartTrading();
        
        // Refresh data periodically
        setInterval(refreshMLModels, 30000);
        setInterval(refreshExchanges, 60000);
        setInterval(refreshPairs, 120000);
        
        showNotification('Meme Millionaire Bot with persistent stats initialized!', 'success');
    </script>
</body>
</html>